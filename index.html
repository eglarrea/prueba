<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lector QR</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0; padding: 24px; background: #0f1115; color: #e8eaed;
    }
	header {
  display: flex;              /* coloca los hijos en fila */
  align-items: center;        /* alinea verticalmente */
  gap: 16px;                  /* espacio entre imagen y texto */
}

header .logo {
  width: 220px;               /* ajusta tama√±o */
  height: auto;               /* mantiene proporci√≥n */
}
    .container {
      max-width: 880px; margin: 0 auto;
      display: grid; gap: 16px;
      grid-template-columns: 1.2fr 1fr;
    }
    header { margin-bottom: 16px; }
    h1 { font-size: 1.6rem; margin: 0 0 8px; }
    .card {
      background: #1a1f29; border: 1px solid #263042; border-radius: 12px;
      padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    button, select, input[type="file"] {
      background: #243041; color: #e8eaed; border: 1px solid #3a4a63;
      padding: 10px 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    button.primary { background: #2d5cf6; border-color: #2d5cf6; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #reader { width: 100%; min-height: 320px; border-radius: 10px; overflow: hidden; }
    .status { font-size: .95rem; opacity: .9; }
    .result {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: #11161f; border: 1px dashed #334155; border-radius: 10px;
      padding: 12px; white-space: pre-wrap; word-break: break-word;
    }
    .hint { font-size: .9rem; opacity: .75; }
    .badge { display: inline-block; background: #1f2937; border: 1px solid #334155;
      padding: 4px 8px; border-radius: 999px; font-size: .8rem; }
	  
	.lcd-display {
      background-color: #001100;
      color: #00FF00;
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.2rem;
      padding: 15px;
      border: 2px solid #00FF00;
      border-radius: 5px;
      box-shadow: 0 0 15px #00FF00;
      text-align: center;
      position: relative;
      top: 0;
      transition: top 1s ease;
    }

   
    .barrier-container {
      background-image: url('fondo.jpg'); /* Ruta de tu imagen */
      background-size: cover; /* O 'contain' para ajustar la imagen */
      background-position: center; 
      position: relative;
      width: 300px;
      height: 200px;
      background-color: #e0e0e0;
      border: 2px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
    }

    .pillar {
      position: absolute;
      bottom: 0;
      left: 50px;
      width: 40px;
      height: 100px;
      background-color: #333;
      border-radius: 5px;
    }

    .arm {
      position: absolute;
      bottom: 90px;
      left: 90px;
      width: 180px;
      height: 10px;
      background-color: white;
      border: 2px solid red;
      transform-origin: left center;
      transition: transform 1s ease;
    }

    .arm.raised {
      transform: rotate(-75deg);
    }
	
	.lcd-display.flash {
		animation: flash 0.5s alternate 3;
	}
	@keyframes flash {
		from { opacity: 1; }
		to { opacity: 0.2; }
	}
  </style>
</head>
<body>
<header>
  <img src="Logo.png" height="100rem" width="100rem" alt="Descripci√≥n de la imagen" class="logo">
  <div>
    <h1>Acceso al √°rea</h1>
    <input type="number" value="1" id="parkingId"/> 
  </div>
</header>

  <div class="container">
    <section class="card">
      <div id="reader"></div>
    </section>

    <aside class="card">
	  <div id="result" class="lcd-display mx-auto mb-4 col-md-6">Esperando escaneo...</div>
      <p class="hint">Consejo: Acerca el QR, evita reflejos y mant√©n el enfoque.</p>
	  <div class="barrier-container">
	   <div class="pillar"></div>
	   <div class="arm" id="barrierArm"></div>
	</div>
    </aside>
  </div>

  <!-- Librer√≠a html5-qrcode desde CDN -->
   <script src="https://unpkg.com/html5-qrcode"></script>

  
  <script>
    let html5QrCode; 
    let processing = false; // flag para evitar lecturas duplicadas

    function abrirBarrera() {
      document.getElementById("result").innerText = "‚úÖ Ongi etorri";
      toggleBarrier();

      setTimeout(() => {
        cerrarBarrera();
      }, 5000);
    }

    function cerrarBarrera() {
      document.getElementById("result").innerText = "üîí Barrera cerrada";
      toggleBarrier();
    
      // detener escaneo antes de reiniciar
      html5QrCode.stop().then(() => {
        console.log("Escaneo detenido, reiniciando...");
    
        return html5QrCode.start(
          { facingMode: "environment" },
          { fps: 5, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
      }).then(() => {
        console.log("Escaneo reanudado");
        setTimeout(() => {
          document.getElementById("result").innerText = "Esperando escaneo...";
        }, 3000);
      }).catch(err => {
        console.error("Error al detener o reanudar escaneo:", err);
      });
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (processing) return; // ignorar si ya se est√° procesando
      processing = true;

      const token = decodedText;
      const idParking = document.getElementById("parkingId").value;
	  const lcd = document.getElementById("result");
	  lcd.classList.add("flash");
	  setTimeout(() => lcd.classList.remove("flash"), 1500);
      
      fetch("https://camperapi.onrender.com/api/public/acceder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, idParking })
      })
      .then(response => {
        if (response.ok) {
          abrirBarrera();
        } else {
          document.getElementById("result").innerText = "‚ùå Token inv√°lido o caducado";
          setTimeout(() => {
            document.getElementById("result").innerText = "Esperando escaneo...";
          }, 3000);
        }
      })
      .catch(error => {
        console.error("Error en la petici√≥n:", error);
        document.getElementById("result").innerText = "‚ö†Ô∏è Error de conexi√≥n";
      })
      .finally(() => {
        processing = false; // listo para el siguiente escaneo
      });
    }

    function onScanFailure(error) {
      // opcional: mostrar errores
    }

    // inicializar esc√°ner
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 5, qrbox: 250 }, // fps reducido
      onScanSuccess,
      onScanFailure
    );

    function toggleBarrier() {
      const arm = document.getElementById('barrierArm');
      arm.classList.toggle('raised');
    }
  </script>
</body>
</html>
